# Deployment â€” Docker ðŸ³

ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ñ‡ÐµÑ€ÐµÐ· Docker Compose.

## ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°

```
deployment/
â”œâ”€â”€ docker-compose.yaml   # ÐžÑ€ÐºÐµÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
â””â”€â”€ README.md             # Ð­Ñ‚Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
```

## ðŸ— ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Docker Network                   â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     Backend     â”‚â—„â”€â”€â”€â”‚         Bot         â”‚ â”‚
â”‚  â”‚   (port 8000)   â”‚    â”‚    (polling mode)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                                      â”‚
â”‚           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚   PostgreSQL   â”‚                            â”‚
â”‚  â”‚  (port 5432)   â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ :8000
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Host/Nginx â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº

### 1. ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°

```bash
cd deployment

# Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸
cat > .env << EOF
# Telegram Bot
BOT_TOKEN=your_telegram_bot_token

# PostgreSQL
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=vmeste_db
POSTGRES_PORT=5432

# Debug Ñ€ÐµÐ¶Ð¸Ð¼
DEBUG=false
EOF
```

### 2. Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²

```bash
# Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº
docker-compose up --build

# Ð—Ð°Ð¿ÑƒÑÐº Ð² Ñ„Ð¾Ð½Ðµ
docker-compose up -d --build

# ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²
docker-compose logs -f

# Ð›Ð¾Ð³Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°
docker-compose logs -f postgres
docker-compose logs -f backend
docker-compose logs -f bot
```

### 3. ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°

```bash
# ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
docker-compose stop

# ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¸ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
docker-compose down

# Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ð¼ÐµÑÑ‚Ðµ Ñ volumes (Ð‘Ð”!)
docker-compose down -v
```

## ðŸ“¦ Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹

### PostgreSQL
- **ÐžÐ±Ñ€Ð°Ð·**: postgres:16-alpine
- **ÐŸÐ¾Ñ€Ñ‚**: 5432 (Ð¿Ñ€Ð¾Ð±Ñ€Ð¾ÑˆÐµÐ½ Ð½Ð° Ñ…Ð¾ÑÑ‚, Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
- **Healthcheck**: pg_isready ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 ÑÐµÐº
- **Volume**: `postgres_data` Ð´Ð»Ñ Ð¿ÐµÑ€ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- **ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ**: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB

### Backend
- **ÐžÐ±Ñ€Ð°Ð·**: Python 3.13-slim + uv
- **ÐŸÐ¾Ñ€Ñ‚**: 8000 (Ð¿Ñ€Ð¾Ð±Ñ€Ð¾ÑˆÐµÐ½ Ð½Ð° Ñ…Ð¾ÑÑ‚)
- **Healthcheck**: GET /health ÐºÐ°Ð¶Ð´Ñ‹Ðµ 30 ÑÐµÐº
- **Ð—Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚**: PostgreSQL (Ð¶Ð´Ñ‘Ñ‚ healthcheck)
- **Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…**: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ðº PostgreSQL Ñ‡ÐµÑ€ÐµÐ· asyncpg

### Bot
- **ÐžÐ±Ñ€Ð°Ð·**: Python 3.13-slim + uv
- **Ð—Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚**: Backend (Ð¶Ð´Ñ‘Ñ‚ healthcheck)
- **Ð ÐµÐ¶Ð¸Ð¼**: Polling (long-polling Ðº Telegram API)

## ðŸ”§ ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

Ð’ Ñ„Ð°Ð¹Ð»Ðµ `.env`:

```env
# ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ
BOT_TOKEN=your_telegram_bot_token

# PostgreSQL (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, ÐµÑÑ‚ÑŒ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ)
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=vmeste_db
POSTGRES_PORT=5432

# Debug Ñ€ÐµÐ¶Ð¸Ð¼
DEBUG=false
```

**Ð’Ð°Ð¶Ð½Ð¾**: `DATABASE_URL` Ð´Ð»Ñ backend Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… PostgreSQL.

## ðŸ” ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹

```bash
# ÐŸÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ backend
docker-compose build backend

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°
docker-compose restart bot

# Ð—Ð°Ð¹Ñ‚Ð¸ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
docker-compose exec postgres psql -U postgres -d vmeste_db
docker-compose exec backend sh
docker-compose exec bot sh

# ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
docker-compose ps

# ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
docker stats
```

## ðŸ›¡ ÐŸÑ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸

1. **Reverse proxy**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Nginx/Traefik Ð¿ÐµÑ€ÐµÐ´ backend
2. **SSL**: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ HTTPS Ñ‡ÐµÑ€ÐµÐ· Let's Encrypt
3. **ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³**: Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Prometheus + Grafana
4. **Ð›Ð¾Ð³Ð¸**: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÐ±Ð¾Ñ€ (ELK, Loki)
5. **Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…**:
   - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹ PostgreSQL
   - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ connection pooling (pgBouncer)
   - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ñ€ÐµÐ¿Ð»Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸
6. **Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ**:
   - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð´Ð»Ñ PostgreSQL
   - ÐÐµ Ð¿Ñ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾Ñ€Ñ‚ 5432 Ð½Ð° Ñ…Ð¾ÑÑ‚ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ
   - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ firewall Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
