# Alembic ‚Äî –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö üì¶

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–∞–±–æ—Ç–µ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Alembic.

## üìã –ß—Ç–æ —Ç–∞–∫–æ–µ Alembic?

Alembic ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ SQLAlchemy. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –°–æ–∑–¥–∞–≤–∞—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î
- –ü—Ä–∏–º–µ–Ω—è—Ç—å –∏ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ–¥–µ–ª–µ–π

## üèó –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
backend/
‚îú‚îÄ‚îÄ alembic.ini          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îú‚îÄ‚îÄ env.py           # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (async –ø–æ–¥–¥–µ—Ä–∂–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ script.py.mako   # –®–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ versions/         # –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md     # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ README.md         # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ src/
    ‚îî‚îÄ‚îÄ ...               # –ú–æ–¥–µ–ª–∏ SQLAlchemy
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü–µ—Ä–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

```bash
cd backend

# –°–æ–∑–¥–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –ë–î —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
uv run alembic revision --autogenerate -m "Initial migration"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
uv run alembic upgrade head
```

## üìù –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

**–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
```bash
# Alembic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—è—Ö
uv run alembic revision --autogenerate -m "–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
```

**–†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
uv run alembic revision -m "–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
```

**–ü—Ä–∏–º–µ—Ä—ã –æ–ø–∏—Å–∞–Ω–∏–π:**
```bash
uv run alembic revision --autogenerate -m "Add user email field"
uv run alembic revision --autogenerate -m "Create events table"
uv run alembic revision --autogenerate -m "Add event participants relationship"
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π:**
```bash
uv run alembic upgrade head
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –º–∏–≥—Ä–∞—Ü–∏—é:**
```bash
uv run alembic upgrade +1
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–≤–∏–∑–∏—é:**
```bash
uv run alembic upgrade <revision_id>
```

**–ü—Ä–∏–º–µ—Ä:**
```bash
uv run alembic upgrade abc123def456
```

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

**–û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é:**
```bash
uv run alembic downgrade -1
```

**–û—Ç–∫–∞—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–≥—Ä–∞—Ü–∏–π:**
```bash
uv run alembic downgrade -2
```

**–û—Ç–∫–∞—Ç–∏—Ç—å –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–≤–∏–∑–∏–∏:**
```bash
uv run alembic downgrade <revision_id>
```

**–û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
uv run alembic downgrade base
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ë–î:**
```bash
uv run alembic current
```

**–ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π:**
```bash
uv run alembic history
```

**–î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è:**
```bash
uv run alembic history --verbose
```

**–ü–æ–∫–∞–∑–∞—Ç—å SQL –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ (–±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è):**
```bash
uv run alembic upgrade head --sql
```

## üîß –†–∞–±–æ—Ç–∞ —Å –º–æ–¥–µ–ª—è–º–∏

### –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

Alembic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—è—Ö SQLAlchemy:

1. **–ò–∑–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å** –≤ `src/users/models.py` –∏–ª–∏ `src/events/models.py`:
   ```python
   class User(Base):
       # –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –ø–æ–ª–µ
       email: Mapped[str | None] = mapped_column(String(255), nullable=True)
   ```

2. **–°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:**
   ```bash
   uv run alembic revision --autogenerate -m "Add user email"
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª** –≤ `alembic/versions/`:
   ```python
   def upgrade() -> None:
       op.add_column('users', sa.Column('email', sa.String(255), nullable=True))

   def downgrade() -> None:
       op.drop_column('users', 'email')
   ```

4. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:**
   ```bash
   uv run alembic upgrade head
   ```

### –ß—Ç–æ Alembic –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

‚úÖ **–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç:**
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ nullable/unique/default

‚ùå **–ù–ï –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç:**
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü/–∫–æ–ª–æ–Ω–æ–∫ (—Å–æ–∑–¥–∞—ë—Ç drop + add)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ SQL –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

–ï—Å–ª–∏ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é:

```python
def upgrade() -> None:
    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ (Alembic –Ω–µ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    op.alter_column('users', 'old_name', new_column_name='new_name')

    # –ö–∞—Å—Ç–æ–º–Ω—ã–π SQL
    op.execute("UPDATE users SET status = 'active' WHERE status IS NULL")

def downgrade() -> None:
    op.alter_column('users', 'new_name', new_column_name='old_name')
    op.execute("UPDATE users SET status = NULL WHERE status = 'active'")
```

## üóÑ –†–∞–±–æ—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –ë–î

### SQLite (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)

```bash
# –í .env
DATABASE_URL=sqlite+aiosqlite:///./app.db

# –ú–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ
uv run alembic upgrade head
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ SQLite:**
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ALTER COLUMN (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ rename_table)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π
- –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### PostgreSQL (Docker/–ø—Ä–æ–¥–∞–∫—à–µ–Ω)

```bash
# –í .env –∏–ª–∏ docker-compose
DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/dbname

# –ú–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ
uv run alembic upgrade head
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ PostgreSQL:**
- –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π ALTER
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –æ—Ç–∫–∞—Ç–∞
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ SQL —Ñ—É–Ω–∫—Ü–∏–∏

## üîÑ Workflow —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –¢–∏–ø–∏—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

1. **–ò–∑–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å:**
   ```python
   # src/users/models.py
   class User(Base):
       phone: Mapped[str | None] = mapped_column(String(20), nullable=True)
   ```

2. **–°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:**
   ```bash
   uv run alembic revision --autogenerate -m "Add user phone"
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:**
   ```bash
   # –û—Ç–∫—Ä–æ–π—Ç–µ alembic/versions/XXXX_add_user_phone.py
   # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ upgrade() –∏ downgrade() –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
   ```

4. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:**
   ```bash
   uv run alembic upgrade head
   ```

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é:**
   ```bash
   uv run alembic current
   ```

### –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
uv run alembic downgrade -1

# –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å –∏–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—é
# ...

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
uv run alembic revision --autogenerate -m "Fixed migration"
```

## üê≥ –†–∞–±–æ—Ç–∞ –≤ Docker

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

```bash
# –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä backend
docker-compose exec backend sh

# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
uv run alembic upgrade head
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ `Dockerfile` –∏–ª–∏ `docker-compose.yaml`:

```dockerfile
# –í Dockerfile
CMD ["sh", "-c", "uv run alembic upgrade head && uv run uvicorn main:app --host 0.0.0.0 --port 8000"]
```

–ò–ª–∏ —á–µ—Ä–µ–∑ entrypoint —Å–∫—Ä–∏–ø—Ç:
```bash
#!/bin/sh
uv run alembic upgrade head
exec uv run uvicorn main:app --host 0.0.0.0 --port 8000
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

Alembic –º–æ–∂–µ—Ç –Ω–µ –∑–∞–º–µ—Ç–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ** —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º.

### 2. –ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –ë–î, **–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ** –µ—ë —Ñ–∞–π–ª. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

### 3. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ downgrade

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `downgrade()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
```bash
uv run alembic upgrade head
uv run alembic downgrade -1
uv run alembic upgrade head
```

### 4. –ë—ç–∫–∞–ø—ã –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ **–≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø** –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π:
```bash
# PostgreSQL
pg_dump -U postgres vmeste_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 5. –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ –∫–æ–º–∞–Ω–¥–µ

- –ö–æ–º–º–∏—Ç—å—Ç–µ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –≤ Git
- –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Ä–∞–±–æ—Ç–æ–π: `git pull` ‚Üí `alembic upgrade head`

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π

–ï—Å–ª–∏ Alembic –Ω–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º–ø–æ—Ä—Ç—ã –º–æ–¥–µ–ª–µ–π** –≤ `alembic/env.py`:
   ```python
   from src.users.models import User
   from src.events.models import Event, EventParticipant
   ```

2. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥–µ–ª–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç Base:**
   ```python
   from src.database import Base

   class User(Base):
       ...
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã:**
   ```python
   # –í Python shell
   from src.database import engine, Base
   from src.users.models import User
   print(Base.metadata.tables.keys())
   ```

### –ü—Ä–æ—Å–º–æ—Ç—Ä SQL –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å SQL –¥–ª—è upgrade
uv run alembic upgrade head --sql

# –ü–æ–∫–∞–∑–∞—Ç—å SQL –¥–ª—è downgrade
uv run alembic downgrade -1 --sql
```

### –õ–æ–≥–∏ Alembic

Alembic –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏. –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `alembic.ini`:
```ini
[logger_alembic]
level = INFO  # DEBUG –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤
```

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Alembic](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Migrations Guide](https://docs.sqlalchemy.org/en/20/core/metadata.html)
- [Alembic Autogenerate](https://alembic.sqlalchemy.org/en/latest/autogenerate.html)

## üí° –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è

```python
# 1. –ò–∑–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å
class User(Base):
    age: Mapped[int | None] = mapped_column(Integer, nullable=True)

# 2. –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
uv run alembic revision --autogenerate -m "Add user age"

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ
uv run alembic upgrade head
```

### –ü—Ä–∏–º–µ—Ä 2: –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏ many-to-many

```python
# 1. –ú–æ–¥–µ–ª—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ (EventParticipant)
# 2. –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
uv run alembic revision --autogenerate -m "Add event participants table"

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ
uv run alembic upgrade head
```

### –ü—Ä–∏–º–µ—Ä 3: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏

```python
# 1. –°–æ–∑–¥–∞–π—Ç–µ –ø—É—Å—Ç—É—é –º–∏–≥—Ä–∞—Ü–∏—é
uv run alembic revision -m "Rename user name to full_name"

# 2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏
def upgrade() -> None:
    op.alter_column('users', 'name', new_column_name='full_name')

def downgrade() -> None:
    op.alter_column('users', 'full_name', new_column_name='name')

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ
uv run alembic upgrade head
```
